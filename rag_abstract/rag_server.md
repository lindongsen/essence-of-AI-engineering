# 任务目标
编写一个http服务(rag_server)完成RAG相关能力。

判断(DONE文件)`/林生的奇思妙想/rag/tasks/rag_server.DONE`是否存在：
- 当(DONE文件)存在，则表达任务目标已经完成，读取(DONE文件)内容作为最终回答。
- 当(DONE文件)不存在，要去完成任务目标，在任务目标完成后，将最终回答写入(DONE文件)。

完成(任务目标)的必要条件：
1. rag_server正常启动；
2. 所有单元测试通过；
3. 所有API测试通过；


# 注意-[文件要求]
- （工作空间）是`/林生的奇思妙想/rag`，如果不存在，你可以创建它，你可以对这个`/林生的奇思妙想/rag`文件夹进行任何改动，包括增、删、改操作。
- 请注意：工作空间是文件夹`/林生的奇思妙想/rag`。本任务的文件变更行为，你（必须）且（只能）在工作空间`/林生的奇思妙想/rag`中进行文件和文件夹的生成和修改。
- 你对所有的文件、文件夹的描述都必须使用（绝对路径），即（必须）对文件或文件夹的全路径进行表达。例如：你应该描述文件`/林生的奇思妙想/rag/cat.md`，不能描述为`cat.md`，也（不能）完全不提文件路径。

# 注意-[不能做的事]
- （不能）使用任何git命令。

# 注意-[尽可能地避免大文本内容的输出]
- 当你要对文件进行检查，尽可能地避免大量文本内容的输出，可以只读取部分内容来检查。如：文本素材的检查，只需要读取头部100字节。
- 当某个测试项会输出大量内容，你应该将测试结果写入到文件，然后读取文件部分内容去验证结果；例如：测试文本向量化计算的时候，会输出大量的向量值，应该输出到文件中，然后读取头部100字节去判断是否执行正常。
- curl工具不需要stderr的内容，使用此参数去忽略它`2>/dev/null`。
- 你应该尽可能地避免‘调用工具或命令时’产生大文本内容的输出，以下列举一些场景：
```
1. 调用API接口将文本进行向量化计算，该接口会返回大量数据，你应该输出到临时文件，再读取临时文件头尾100字节去做判断。
2. 文本素材准备好后，你应该读取文件头部100字节去做检查，而不是读取整个文件。
3. 调用API接口将用户问题进行检索，生成检索结果，该接口会返回大量数据，你应该输出到临时文件，再读取临时文件头尾100字节去做判断。
```

----

# RAG是什么
RAG, Retrieval-Augmented Generation。
RAG 是一种将外部知识库与大语言模型相结合的技术，旨在让模型生成的内容更准确、更具时效性、且来源可追溯。

# RAG的工作原理

## 数据准备
将文档切分成小块（也称为‘知识片段’），使用（嵌入模型）将这些小块文本转换成向量，将小块文本和向量存入向量数据库。

## 数据查询
用户提出问题，同样使用嵌入模型将问题转换成向量，然后，到向量数据库进行相似度搜索，找出与问题最接近的几个知识片段。

## 提示词准备
将用户问题和检索到的知识片段进行整合，构造提示词。
模板如下：
```
# 基于（信息）回答（问题）

# 信息
1. {知识片段1}
2. {知识片段2}
3. {知识片段3}

# 问题
{用户问题}
```

## 大模型生成
大模型根据这个提示，生成最终答案。


# 减少RAG处理问题耗时的想法
在‘提示词准备’阶段，通过减少‘知识片段’，增加‘摘要片段’，从而减少提示词输入量，进而减少大模型的思考时间。
‘摘要片段’是指对知识片段进行概括，形成摘要总结。

## RAG的‘数据准备’阶段中
增加以下步骤：
1. 将‘知识片段’用‘google/pegasus-large’本地模型处理得到一个‘摘要片段’。
2. 使用嵌入模型将这些‘摘要片段’转换成向量，并将摘要片段和向量存入向量数据库，注意-要使用不同的数据库名称，例如：存储‘知识片段’用的是‘cat_raw’名字，存储‘摘要片段’用的是'cat_abstract'名字。

## RAG的‘数据查询’阶段中
1. 向量数据库的相似度搜索会产生两类数据，一个是‘知识片段’，一个是‘摘要片段’，并且数量不同，‘知识片段’远小于‘摘要片段’，如比例‘5:50’。

## RAG的‘提示词准备’阶段中
‘信息’不仅包含'知识片段'，而且也包含‘摘要片段’，知识片段在前，摘要片段在后。

----

# 技术栈
- 开发语言：python，使用uv工具进行工作空间管理，使用`uv init`对工作空间进行初始化，测试和运行也必须用`uv run python 文件`去执行，增加包依赖使用`uv add 包名`。
- 单元测试：pytest
- HTTP服务：fastapi
- 向量数据库：chromadb，使用持久性本地保存模式。
- 文本向量化开发框架：sentence-transformers
- 文本向量化模型：BAAI/bge-large-zh-v1.5
- 文本转换‘摘要’模型：google/pegasus-large

# 注意事项
- 本计划中涉及的所有新文件都（必须）创建在（工作空间）里面。
- 相关技术栈的使用如果模糊，可以读取此文件`/林生的奇思妙想/essence-of-AI-engineering/ai_base/rag_base.py`进行参考。
- 尽可能将不同功能类别的方法写到不同的文件中，当存在重复任务时，可以检查功能是否在期望中，并且是否可用，从而判断任务是否需要执行。
- python文件命名为`rag_server.py`，服务名字是`rag_server`。
- 代码需要对各种（操作行为）打印日志，日志内容必须包含：日志等级、时间、线程id、日志信息等。不用对操作“结果”打印日志，例如：知识分片、向量值的内容，不然会给日志阅读带来极大困难。`rag_server`的日志文件名为`rag_server.log`。
- 编写脚本实现 启动、关闭、重启 服务，如：start_rag_server.sh，stop_rag_server.sh，restart_rag_server.sh，你要尽量使用这些脚本。
- 使用nohup命令启动服务，将启动日志输出到文件。如：`nohup start_rag_server.sh > start_rag_server.log 2>&1 &`。
- 严格遵守上面的’注意-[文件要求]‘。
- 严格遵守上面的’注意-[不能做的事]‘。

# 功能内容
两大类功能：数据准备和数据检索。

大功能中的小功能都能提供API接口，如：文本的向量化计算、文本的摘要生成等。

## 数据准备功能
1. 读取一个文本文件，并将文本切片，切片规则是尽量按完整段落切分，通常是（换行符）去区分段落，即使知识片段的大小已经（大于）切片大小，仍然要继续增加知识片段的内容，直到段落结束。 该方法能得到具有（完整段落）的知识片段；
2. 将知识片段计算md5，将知识片段进行向量化计算，得到‘知识片段’、‘md5值’和‘向量值’，如：[(知识片段1，md5值1, 向量1),(知识片段2,md5值2,向量2)]；
3. 将知识片段进行摘要化处理，并对摘要片段进行向量化计算，结合步骤2的知识片段的md5值，得到（‘摘要片段’，‘知识片段的md5值’，‘摘要片段的向量值’）。
4. 将上述步骤2和步骤3得到的数据分别存入各自的向量数据库，注意：存放在不同的数据库名字中，如‘cat_raw’和‘cat_abstract’；

注意：
- 数据准备的步骤中，API应该支持传入(名字)作为数据库名的一部分，你应该根据文本素材去使用一个英文名字，例如：名字是‘cat’，知识片段的数据库是‘cat_raw’，摘要片段的数据库是‘cat_abstract’;
- 数据准备的步骤都要提供API接口，这样就可以针对性的单独使用；

## 数据检索功能
1. 让用户能输入问题；
2. 将问题进行向量化计算；要提供单独的API接口；
3. 从向量数据库里面进行相似度检索；要提供单独的API接口，将问题作为参数调用api就能得到检索结果；
4. 构造“提示词”；
5. 向大模型征求最终答案，该步骤可以调用命令行：`llm_chat 提示词内容`。

注意：
- 数据检索的步骤中，从步骤2开始要记录时间，输出步骤1之后的每个步骤的执行时间和这些步骤的总耗时。
- 可以用参数控制“是否启用‘摘要’检索”，不启用就是传统RAG的做法，启用了就是为了验证本计划的想法。

## 其它功能
1. 关闭服务功能：提供API接口去关闭服务。
2. 心跳功能：提供API接口去检查心跳，从而判断服务是否健康。

# 功能验证
1. 对各个功能进行单元测试，确保测试通过。当测试不通过时，可以直接修改代码，再进行测试；当尝试修改代码的次数超过20次，测试依然不通过，就请用户介入；
2. 使服务在后台运行，如：`nohup start_rag_server.sh > start_rag_server.log 2>&1 &`，通过curl命令进行API测试。当测试不通过时，请停止服务，之后可以直接修改代码，再进行测试；当尝试修改代码的次数超过20次，测试依然不通过，就请用户介入；API测试必须全部通过。
3. 启动服务后，你必须检查服务是否启动正常？例如：通过心跳检查，通过tcp监听端口检查，通过进程检查。关闭服务后，你必须检查服务是否成功关闭？
4. 全部测试通过后，服务不用关闭，保持运行。

# [测试]注意事项
- 测试文件存放到`/林生的奇思妙想/rag/tests`，这是测试文件的基础目录。单元测试文件夹是`unit`，API功能测试文件夹是`api`，它们都在`/林生的奇思妙想/rag/tests`里面。
- 所有的测试文件必须使用‘test_’作为文件名前缀，如：`test_rag_server.py`。
- 使用API进行功能测试也需要独立的测试脚本。
- 多加思考，再次重申上面的：“注意-[尽可能地避免大文本内容的输出]”,你要特别注意‘向量化数据’、‘文本片段’的输出内容都会很多。

----
