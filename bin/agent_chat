#!/bin/bash
# Author: DawsonLin
# Email: developer@yunify.com
# Created: 2025-10-19
# Purpose:
#  Env:
#    @SESSION_ID: string;
#    @SYSTEM_PROMPT: file or content;

BASE_NAME=$(basename "$0")
ARG1=$1
[ "${ARG1}" != "-" ] && [ "${ARG1:0:1}" == "-" ] && {
  echo "Usage: ${BASE_NAME} [TASK]"
  echo "
Env:
  [SESSION_ID]
    set session id for persistent memory

  [SYSTEM_PROMPT]
    a file path

Example:
  - ${BASE_NAME} 'chat content'
  - SYSTEM_PROMPT=/path/to/file ${BASE_NAME} 'chat content'
"

  exit 1
}

WORK_DIR=""

function error_quit() {
    echo "ERROR: $*"
    echo ""
    exit 1
}

# get work_dir
for _dir in "/root/ai/essence-of-AI-engineering" "/林生的奇思妙想/essence-of-AI-engineering"; do
  [ -e "${_dir}" ] && WORK_DIR=${_dir} && break
done

[ -n "${WORK_DIR}" ] || error_quit “no found work_dir”

cd "${WORK_DIR}" || error_quit "enter work_dir failed: ${WORK_DIR}"

# debug, default is 0
[ "${DEBUG}" == "" ] && DEBUG=0
export DEBUG

# task
task="$*"
task_ex=""
if [ "$1" == "-" ]; then
  task=$(cat "$1")
  [ "$2" != "" ] && task_ex=$(echo -e "\n----\n$*")
fi

# print histroy messages
[ -n "${SESSION_ID}" ] && {
  command -v ai_retrieve_messages > /dev/null && ai_retrieve_messages "${SESSION_ID}"
}

# start
DEBUG=1 uv run python cli/agent_chat.py "${task} ${task_ex}"
[ -n "${SESSION_ID}" ] && for _ in {1..100}; do
  echo ""
  read -r -p ">>> Your turn: " user_input
  [ -z "${user_input}" ] && continue
  [ "${user_input}" == " " ] && continue
  if [ "${user_input}" == "quit" ] || [ "${user_input}" == "exit" ]; then
    exit 0
  fi
  DEBUG=1 uv run python cli/agent_chat.py "${user_input}"
done
